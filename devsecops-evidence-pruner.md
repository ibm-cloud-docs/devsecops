---

copyright: 
  years: 2023, 2023
lastupdated: "2023-05-29"

keywords: DevSecOps, compliance evidence, IBM Cloud, evidence pruner

subcollection: devsecops

---

{{site.data.keyword.attribute-definition-list}}

# Using the Evidence Pruning tool to remove compliance evidences generated before a designated time
{: #devsecops-prune-evidence}

Collecting evidence an essential aspect of the DevSecOps reference architecture. Compliance evidence establishes an audit trail that auditors seek during compliance audits. One of the objectives of DevSecOps is to automate the generation and storage of evidence in auditable evidence lockers. The primary locker for housing evidences is the Git repository.
{: shortdesc}

However, due to the substantial volume of evidence generated by DevSecOps pipelines, the Git repository continuously expands causing performance degradation and failure during pipeline runs. Therefore, it becomes necessary to eliminate older evidence. 

The Cloud Object Storage bucket functions as a secondary evidence repository and automatically prunes evidence based on a retention policy of 365 days. However, the Git Evidence Repository, serving as the primary evidence repository, requires explicit cleanup of evidence that surpasses the 365-day threshold. The evidence pruning tool discussed here eliminates any evidence generated prior to a designated time for the Git Evidence Repository.
{: attention}

## Running the evidence pruning tool
{: #devsecops-prune-evidence-run}

The Evidence Pruning trigger is preconfigured for DevSecOps pipelines that are created after the v9.16.0 release of compliance pipelines. However, the following steps serve as a guide for users who have existing DevSecOps Toolchains.

### Add a manual trigger  
{: #devsecops-prune-evidence-trigger}

While there are no strict guidelines regarding the choice of pipelines (CI, CD, or CC) for configuring the Evidence Pruning Tool to run, you must set it up within the CC Pipeline as a recommended practice.

Based on your choice of pipeline, go to **Pipeline Configuration" > Triggers > Add > Manual**.

![Add Manual Trigger](images/devsecops-pipeline-config-manual-trigger.png){: caption="Figure 1. Manual trigger for Pruning Evidence" caption-side="bottom"}

### Select the prune evidence listener for the trigger
{: #devsecops-prune-evidence-select}

In the context of one-pipeline, the Evidence Pruning Tool appears as a new tekton listener for the pipeline. 
![Prune Evidence Listener](images/devsecops-triggers-evidence-pruner.png){: caption="Figure 2. One Pipeline Tekton Listener for Pruning Evidence" caption-side="bottom"}

### Configure the environment properties for the trigger
{: #devsecops-prune-evidence-props}

Configure the following environment properties

|Name |Type	|Description |Required or Optional |
|:----------|:------------------------------|:------------------|:----------|
| `evidence-retention-days` 		|Text 		| The duration, measured in days, for which evidence should be retained. Default is `365`. | Required			|
| `evidence-pruner-batch-size`	|Text		| The count of evidence files that undergo cleanup before updating the pull request. Default is `1000`.	| Optional			|
| `evidence-pruner-branch`	|Text 		| The branch within the evidence locker Git repository that is created to facilitate the cleanup and promotion of evidence within the default branch. Default is `chore/prune-evidences`. | Optional			|
| `opt-in-v1-evidence-pruner`		|Text		| When set to `1`, all the v1 evidence files are removed.	Default is `0`.| Optional			|
| `opt-in-v2-evidence-pruner`		|Text		| When set to `1`, all the v2 evidence files generated before `evidence-retention-days` days are removed. Default is `0`.|Optional			|
{: caption="Table 1. Prune evidence trigger parameters}

![Configure Evidence Pruner Trigger](images/devsecops-triggers-evidence-pruner-1.png){: caption="Figure 3. Configure Evidence Pruner Trigger withe Environment Properties" caption-side="bottom"}

### Runing the manual trigger
{: #devsecops-prune-evidence-run}

When the Evidence Pruner trigger is configured with the appropriate environment properties, the evidence pruner pipeline can be triggered similarly to other pipelines.

The trigger performs the following steps:

1. Clones the evidencere rpository.
1. Generates a list of all files created a specified number of `evidence-retention-days` before the current date.
1. Deletes an initial batch of files, where the batch size is determined by `evidence-pruner-batch-size`.
1. Creates a pull request for the evidence repository, using the `evidence-pruner-branch` as the source branch and the default configured branch as the destination.
1. Iterates through the list generated in Step 2 to remove the corresponding files from the repository in Step 3, and updates the Pull Request from Step 4.
1. Generates a summary of the activities performed, including a link to the Pull Request.

### Review and merge the pull request
{: #devsecops-prune-evidence-merge}

When the pull request is generated for the evidence repository, you can review and merge it accordingly. The following is an example of how a sample pull request after the completion of the evidence pruner pipeline.

![Merge Pull Request](images/devsecops-triggers-evidence-pruner-2.png){: caption="Figure 4. Merge Pull Request" caption-side="bottom"}

### Customize the trigger
{: #devsecops-prune-evidence-custom}

The evidence pruning tool is implemented by using [Custom Tasks](/docs/devsecops?topic=custom-scripts) in DevSecOps pipelines. You should use the default implementation. However, you can also extend or replace the default implementation with a custom implementation. Customize the default by introducing a stage definition in `.pipeline-config.yaml`, which instructs the pipeline to override the default stage definition. The following code snippet invokes the default implementation of the evidence pruning script located at `/opt/commons/prune-evidence/run.sh` within the compliance-baseimage Docker image. If you want to customize the default implementation, substitute this snippet with your own implementations.

```yaml

  prune-evidence:
    image: icr.io/continuous-delivery/pipeline/pipeline-base-ubi:3.18
    dind: false
    abort_on_failure: stopAndFail
    image_pull_policy: IfNotPresent
    script: |
      #!/bin/sh

      "/opt/commons/prune-evidence/run.sh"
```
{: codeblock}

### Configure the listener for the timed trigger
{: #devsecops-prune-evidence-automate}

Automate the evidence pruning activity to be invoked at periodic intervals by configuring a timed trigger as follows:

Go to **Pipeline Configuration" > Triggers > Add > Timed*.

![Add Timed Trigger](images/devsecops-pipeline-config-timed-trigger.png){: caption="Figure 1. Timed Trigger for Pruning Evidence" caption-side="bottom"}
